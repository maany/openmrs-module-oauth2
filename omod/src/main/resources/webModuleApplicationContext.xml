<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xmlns:oauth="http://www.springframework.org/schema/security/oauth2"
       xmlns:security="http://www.springframework.org/schema/security"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
  		    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
  		    http://www.springframework.org/schema/context
  		    http://www.springframework.org/schema/context/spring-context-3.0.xsd
  		    http://www.springframework.org/schema/mvc
  		    http://www.springframework.org/schema/mvc/spring-mvc.xsd
  		    http://www.springframework.org/schema/security/oauth2
  		    http://www.springframework.org/schema/security/spring-security-oauth2-1.0.xsd
  		    http://www.springframework.org/schema/security
  		    http://www.springframework.org/schema/security/spring-security-3.2.xsd">
    <!--
                    http://www.springframework.org/schema/security
                    http://www.springframework.org/schema/security/spring-security-3.0.3.xsd">
        -->

    <!-- Add here beans related to the web context -->


    <!-- Annotation based controllers -->
    <bean class="org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping"/>
    <context:component-scan base-package="org.openmrs.module.oauth2.web.controller"/>
    <mvc:annotation-driven/>

    <!--Begin Spring Security configurations-->

    <!--=============================================================================-->
    <!--Sample Web/HTTP Security Configuration. Listing Spring Security protected resources
        add details to restric access based on Role, Scope, Method-->
    <!--=============================================================================-->

    <!--

        <security:http pattern="/module/**" use-expressions="true"
                       authentication-manager-ref="authenticationManager">
                <security:intercept-url pattern="/module/oauth2/**" access="hasRole('ROLE_USER')"/>
                <security:intercept-url pattern="/module/fhir/**" access="hasRole('ROLE_USER')"/>
                <security:intercept-url pattern="/module/basicmodule/**" access="hasRole('ROLE_USER')"/>
                <security:form-login/>
            </security:http>

    -->

    <!--===================================================================-->
    <!--Authentication Manager and Authentication Provider for OpenMRS users-->
    <!--Link to OpenMRS users Table mapped to Spring Security UserService-->
    <!--This will be used to process User credentials when he/she authorizes an OAuth Client-->
    <!--via Authorization Code/ Implicit Grant Type-->
    <!--===================================================================-->
    <security:authentication-manager alias="authenticationManager">
        <security:authentication-provider>
            <security:user-service id="userDetailsService">
                <security:user name="bob" authorities="ROLE_USER" password="bob"/>
            </security:user-service>
        </security:authentication-provider>
    </security:authentication-manager>
    <!--<bean id="userAuthenticationProvider" class=""/>-->
    <!--============================-->
    <!--OAuth2 Entry Points. What is Realm Name??
        @see http://stackoverflow.com/questions/10892336/realm-name-in-tomcat-web-xml
        name for the resource we are protecting. It is not user name rather it describes the
        computer or system we are protecting-->
    <!--============================-->

    <!--Entry point for OAuth2 protected resources. Configure later based on application demands-->
    <bean id="oauthAuthenticationEntryPoint"
          class="org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint">
        <property name="realmName" value="openmrs"/>
    </bean>

    <!--To be used with token endpoint to initiate client credentials verification-->
    <bean id="clientAuthenticationEntryPoint"
          class="org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint">
        <property name="realmName" value="openmrs/client"/>
        <property name="typeName" value="Basic"/>
    </bean>

    <!--==============================================-->
    <!--Spring http security for Token Endpoint-->
    <!--==============================================-->
    <security:http pattern="/ws/oauth/token" create-session="stateless"
                   authentication-manager-ref="clientAuthenticationManager">
        <security:intercept-url pattern="/oauth/token" access="IS_AUTHENTICATED_FULLY"/>
        <security:anonymous enabled="false"/>
        <security:http-basic entry-point-ref="clientAuthenticationEntryPoint"/>
        <!-- if http basic header is not supplied, authenticate clients directly via request parameters -->
        <security:custom-filter ref="clientCredentialsTokenEndpointFilter" after="BASIC_AUTH_FILTER"/>
        <security:access-denied-handler ref="oauthAccessDeniedHandler"/>
    </security:http>

    <!--Web/Http Security Configuration for OpenMRS Web Services under OAuth2 control -->
    <security:http pattern="/ws/fhir/**" use-expressions="true" entry-point-ref="oauthAuthenticationEntryPoint"
                   authentication-manager-ref="authenticationManager">
        <security:anonymous enabled="false"/>
        <security:intercept-url pattern="/ws/fhir/**" access="hasAnyRole('ROLE_USER','ROLE_CLIENT')"/>
        <!--<security:intercept-url pattern="/ws/rest/**" access="hasAnyRole('ROLE_USER','ROLE_CLIENT')"/>-->
        <security:custom-filter ref="OpenMRSGenericResourceServerFilter" before="PRE_AUTH_FILTER"/>
        <security:access-denied-handler ref="oauthAccessDeniedHandler"/>
    </security:http>
    <!--User Login Page used prior to Authorization Code Grant Type-->
    <!--TODO Currently using form-login, replace with custom login form-->
    <http access-denied-page="/login.jsp?authorization_error=true" disable-url-rewriting="true"
          xmlns="http://www.springframework.org/schema/security">
        <intercept-url pattern="/ws/oauth/**" access="ROLE_USER"/>
        <intercept-url pattern="/ws/**" access="IS_AUTHENTICATED_ANONYMOUSLY"/>

        <form-login/>
    </http>

    <!--==============================================================================================-->
    <!--Token Endpoint : Access Denied Handler for OAuth2 used by the ExceptionTranslationFilter when
        client tries to access resource for which it does not have necessary permissions -->
    <!--==============================================================================================-->
    <bean id="oauthAccessDeniedHandler"
          class="org.springframework.security.oauth2.provider.error.OAuth2AccessDeniedHandler"/>
    <!--=================================================================================================-->
    <!--Allows Username and Password to be passed directly as Request Parameters to the token endpoint -->
    <!--instead of Base64 encoded values in Authorization header (HTTP Basic)-->
    <!--=================================================================================================-->
    <bean id="clientCredentialsTokenEndpointFilter"
          class="org.springframework.security.oauth2.provider.client.ClientCredentialsTokenEndpointFilter">
        <property name="authenticationManager" ref="clientAuthenticationManager"/>
    </bean>

    <!--==============================================-->
    <!--Authentication Manager and Authentication Provider for OAuth2 Clients-->
    <!--==============================================-->
    <authentication-manager id="clientAuthenticationManager" xmlns="http://www.springframework.org/schema/security">
        <authentication-provider user-service-ref="clientDetailsUserService"/>
    </authentication-manager>

    <!--================================================================================-->
    <!--Access Decision Manager. Strategy : All voters should vote ACCESS_GRANTED (UnanimousBased)
        Protected Resources such as FHIR, REST URI's must include this as <http access-decision-manager-ref= accessDecisionManager .....> -->
    <!--================================================================================-->
    <bean id="accessDecisionManager" class="org.springframework.security.access.vote.UnanimousBased"
          xmlns="http://www.springframework.org/schema/beans">
        <constructor-arg>
            <list>
                <bean class="org.springframework.security.oauth2.provider.vote.ScopeVoter"/>
                <bean class="org.springframework.security.access.vote.RoleVoter"/>
                <bean class="org.springframework.security.access.vote.AuthenticatedVoter"/>
            </list>
        </constructor-arg>
    </bean>

    <!--=====================================-->
    <!-- Begin OAuth2 Explicit Configurations    -->
    <!--=====================================-->

    <!--==========================================-->
    <!--OAuth Resource Server for OpenMRS instance-->
    <!--==========================================-->

    <oauth:resource-server id="OpenMRSGenericResourceServerFilter" resource-id="OpenMRS"
                           token-services-ref="tokenServices"/>
    <!--================================================================================-->
    <!--TODO add/verify docs-->
    <!--Verifies is user has authorized the client and then the token has been issued-->
    <!--==================================================================================-->
    <bean id="userApprovalHandler"
          class="org.springframework.security.oauth2.provider.approval.TokenServicesUserApprovalHandler">
        <property name="tokenServices" ref="tokenServices"/>
    </bean>
    <!--==============================-->
    <!--OAuth2 Authorization Server-->
    <!-- =========================== -->
    <oauth:authorization-server client-details-service-ref="clientDetails" token-services-ref="tokenServices"
                                user-approval-handler-ref="userApprovalHandler" token-endpoint-url="/oauth2/token"
                                user-approval-page="/module/oauth2/access_confirmation"
                                approval-parameter-name="user_oauth_approval"
                                error-page="/module/oauth2/oauth_error">
    <oauth:authorization-code/>
        <oauth:implicit/>
        <oauth:refresh-token/>
        <oauth:client-credentials/>
        <oauth:password/>
    </oauth:authorization-server>


    <!--==============================================================================-->
    <!--Create custom bean for ClientDetailsService to read from oauth2_client Table-->
    <!--==================================================================================-->

    <bean id="clientDetailsUserService"
          class="org.springframework.security.oauth2.provider.client.ClientDetailsUserDetailsService">
        <constructor-arg ref="clientDetails"/>
    </bean>

    <!--=======================================================================================================-->
    <!--OAuth2 Sample Clients.-->
    <!--=======================================================================================================-->
    <oauth:client-details-service id="clientDetails">
        <oauth:client client-id="my-trusted-client"
                      authorized-grant-types="password,authorization_code,refresh_token,implicit"
                      authorities="ROLE_CLIENT, ROLE_TRUSTED_CLIENT" scope="read,write,trust"
                      access-token-validity="60"/>
        <oauth:client client-id="openmrs-client"
                      authorized-grant-types="password,authorization_code,refresh_token,implicit"
                      secret="somesecret" authorities="ROLE_CLIENT, ROLE_TRUSTED_CLIENT"
                      redirect-uri="http://anywhere?key=value"/>
        <oauth:client client-id="my-client-with-secret" authorized-grant-types="client_credentials"
                      authorities="ROLE_CLIENT"
                      scope="read" secret="secret"/>
        <oauth:client client-id="my-less-trusted-client" authorized-grant-types="authorization_code,implicit"
                      authorities="ROLE_CLIENT"/>
        <oauth:client client-id="my-less-trusted-autoapprove-client" authorized-grant-types="implicit"
                      authorities="ROLE_CLIENT" scope="read,write,trust"/>
        <oauth:client client-id="my-client-with-registered-redirect"
                      authorized-grant-types="authorization_code,client_credentials"
                      authorities="ROLE_CLIENT" redirect-uri="http://anywhere?key=value" scope="read,trust"/>
        <oauth:client client-id="my-untrusted-client-with-registered-redirect"
                      authorized-grant-types="authorization_code"
                      authorities="ROLE_CLIENT" redirect-uri="http://anywhere" scope="read"/>
        <oauth:client client-id="tonr" resource-ids="OpenMRS" authorized-grant-types="authorization_code,implicit"
                      authorities="ROLE_CLIENT" scope="read,write" secret="secret"/>
    </oauth:client-details-service>

    <!--==========================================================================================-->
    <!--Default Token Store. Replace with JdbcTokenStore to persist tokens in module's database-->
    <!--==========================================================================================-->
    <bean id="tokenStore" class="org.springframework.security.oauth2.provider.token.InMemoryTokenStore"/>

    <!--=============================================================================-->
    <!--Default Token Service to manage tokens. Wire up with custom JdbcTokenStore-->
    <!--=============================================================================-->

    <bean id="tokenServices" class="org.springframework.security.oauth2.provider.token.DefaultTokenServices">
        <property name="tokenStore" ref="tokenStore"/>
        <property name="supportRefreshToken" value="true"/>
        <property name="clientDetailsService" ref="clientDetails"/>
    </bean>
    <!--====================================================================================-->
    <!--Enable OAuth2 expressions in xml and annotations (for method security mechanisms)-->
    <!--====================================================================================-->
    <security:global-method-security pre-post-annotations="enabled" proxy-target-class="true">
        <!--you could also wire in the expression handler up at the layer of the http filters. See https://jira.springsource.org/browse/SEC-1452 -->
        <security:expression-handler ref="oauthExpressionHandler"/>
    </security:global-method-security>

    <oauth:expression-handler id="oauthExpressionHandler"/>

    <oauth:web-expression-handler id="oauthWebExpressionHandler"/>


</beans>
